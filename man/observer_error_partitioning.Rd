% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/observer_error_partitioning.R
\name{observer_error_partitioning}
\alias{observer_error_partitioning}
\title{Partition intra- and inter-observer uncertainty (replicate-based)}
\usage{
observer_error_partitioning(
  data,
  metadata,
  variables = c("TurnAng", "sdTurnAng", "Distance", "Length", "StLength", "sdStLength",
    "Sinuosity", "Straightness", "TrackWidth", "PaceAng")
)
}
\arguments{
\item{data}{A \code{track} R object, which is a list consisting of two elements:
\itemize{
\item \strong{\code{Trajectories}}: A list of interpolated trajectories, where each trajectory is a series of midpoints between consecutive footprints.
\item \strong{\code{Footprints}}: A list of data frames containing footprint coordinates, metadata (e.g., image reference, ID), and a marker indicating whether the footprint is actual or inferred.
}}

\item{metadata}{A data frame with one row per track (same order as
\code{track_param(data)}). Required columns:
\itemize{
\item \code{replica} — replicate index within (\code{track}, \code{observer}).
\item \code{track} — biological track ID.
\item \code{observer} — observer ID.
}}

\item{variables}{A character vector of parameters to analyze. Default is
\code{c("TurnAng","sdTurnAng","Distance","Length","StLength","sdStLength",
          "Sinuosity","Straightness","TrackWidth","PaceAng")}.}
}
\value{
An \code{"error_partitioning"} R object consisting of a list
containing the following elements:

\item{summary}{Data frame of variance components per variable.
Columns: \code{variable}, \code{component}, \code{variance},
\code{percent}, and \eqn{R^2_c}. Components reflect what was
estimable (e.g., \code{track}, \code{observer},
\code{observer:track}, \code{Residual}).}

\item{snr}{Data frame with the signal-to-noise ratio per variable.
Columns: \code{variable}, \code{bio_component} (always \code{"track"}),
\code{bio_var}, \code{error_var}, and \code{SNR}.
The SNR is
\deqn{SNR = Var(track) / [Var(observer) + Var(observer:track) + Var(Residual)].}}

\item{qc}{Compact quality-control table per variable with \code{SNR},
a qualitative \code{SNR_rating} (\code{"weak"}, \code{"moderate"},
\code{"strong"}), the \code{top_component} by percent, its
\code{top_percent}, \eqn{R^2_c}, and whether the observer term was
estimable (\code{observer_estimable}).}

\item{analysis_table}{Data frame used in the analysis: selected
variables joined with \code{metadata} (columns typically include
\code{replica}, \code{track}, and \code{observer}).}

\item{models}{Fitted mixed-effects models used to extract variance
components. For linear variables, each entry stores the \code{lmer}
fit and its variance components. For angular variables, each entry is
a list with separate \code{sin} and \code{cos} fits.}

\item{formulae}{Model formula(e) per variable. For angular variables,
a list containing the \code{sin} and \code{cos} formulas.}

\item{track_names}{Character vector of internal track labels used in
the analysis.}
}
\description{
\code{observer_error_partitioning()} quantifies how much variance in trackway parameters
is due to observer and replicate effects (inter-/intra-observer) versus genuine
between-track (biological) differences, using replicated digitizations and mixed-effects models
(no anatomical simulation).
}
\details{
This function partitions the variability of each selected metric into
components attributable to \strong{biology} (consistent differences among
tracks) and to the \strong{human sampling process}: differences between
observers (\strong{inter-observer sampling error}) and differences between
repeated digitizations by the same observer (\strong{intra-observer sampling error}).
Use it to audit reproducibility across people and sessions, identify metrics
that remain stable despite who digitizes them, and prioritize where protocol
changes (clearer landmark definitions, training, calibration) will most reduce
measurement noise. Metrics whose variability is dominated by biological signal
are more interpretable downstream (testing, clustering, classification),
whereas those dominated by observer/replica effects warrant caution or
methodological refinement.

For each metric the model fits random intercepts for
\code{track}, \code{observer}, and their \code{observer:track} interaction.
Replicate-to-replicate scatter within the same (\code{observer}, \code{track})
cell contributes to the residual (this is the intra-observer sampling error).
Random terms that appear with a single level are dropped automatically.

\deqn{y \sim 1 + (1|track) + (1|observer) + (1|observer:track).}

Angular variables (\code{TurnAng}, \code{PaceAng}) are handled in sine–cosine
space to respect circularity and avoid 0°/360° discontinuities: the same
random-effects structure is fit separately to \eqn{\sin(\theta)} and \eqn{\cos(\theta)},
and the two variance decompositions are averaged (Fisher, 1995).

Robustness is summarized by the signal-to-noise ratio
\deqn{SNR = \frac{Var(track)}{Var(observer) + Var(observer:track) + Var(Residual)}.}
As a rule of thumb:
\itemize{
\item \strong{SNR < 1} — observer/replicate error exceeds biology; the metric is \emph{weak};
\item \strong{SNR ~ 1–2} — biology and error are comparable; \emph{moderate} robustness;
\item \strong{SNR > 2} — biology dominates; \emph{strongly robust}.
}
A compact QC table reports SNR, the qualitative rating, the top variance
component by percent, and the conditional \eqn{R^2_c}; it also flags whether
the inter-observer term was estimable (>1 level).

Practical designs:
\itemize{
\item \emph{Full inter + intra}: provide multiple observers \emph{and} multiple
replicates per observer. Both \code{observer} and \code{observer:track} are estimable; replicate scatter is residual.
\item \emph{Intra-only}: set \code{metadata$observer} to the same value for all rows
and provide \code{replica} with >1 levels. Only \code{track} remains; replicate scatter is residual.
\item \emph{Inter-only}: set \code{metadata$replica} to a single level and supply multiple observers.
\code{observer} is estimable; the residual still represents replicate-level noise (if present).
}

Note that estimates can be sensitive when designs are highly
unbalanced or sample sizes are small; singular fits (random variances at/near
zero) may occur (REML) and should be interpreted cautiously.
This function does not simulate anatomical landmark jitter; to quantify
sensitivity to landmark placement itself (e.g., preservation, landmark
ambiguity), use \code{anatomical_error_partitioning()}.

All \strong{replicated digitizations} (across observers and/or replicate
attempts) must be bundled together in this single \code{data}
object (i.e., in the same file), with each replicate represented
as its own track entry. Do not split replicates across multiple
files/objects, as \code{track_param(data)} and \code{metadata}
must align one row per replicate in the same order.
}
\section{Logo}{

\if{html}{\figure{Logo.png}{options: width=120}}
}

\examples{
# Example 1: Full partition (inter + intra via residual)
# Model: (1|track) + (1|observer) + (1|observer:track).
# Var(track)=biology; Var(observer)=inter-observer;
# Var(observer:track)=observer×track; Residual=intra-observer.
tps <- system.file("extdata", "PaluxyRiverObsRep.tps",
                   package = "QuAnTeTrack")
RL <- rep(c("R","L"), length.out = 34)
trks <- tps_to_track(file = tps, scale = 0.004341493,
                     R.L.side = RL, missing = FALSE, NAs = NULL)

n  <- length(trks$Trajectories)
md <- data.frame(
  track    = rep(c("T01","T02"), length.out = n),
  observer = ifelse(seq_len(n) <= ceiling(n/2), "obs1", "obs2"),
  stringsAsFactors = FALSE
)
md$replica <- ave(seq_len(n),
                  interaction(md$observer, md$track, drop = TRUE),
                  FUN = seq_along)
md <- md[, c("replica","track","observer")]

vars <- c("Distance","Straightness","TurnAng","PaceAng")
res_full <- observer_error_partitioning(data = trks,
                                        metadata = md,
                                        variables = vars)
res_full$qc

# Example 2: Intra-only, single observer; residual = intra-observer
md_intra <- md
md_intra$observer <- "obs1"
res_intra <- observer_error_partitioning(data = trks,
                                         metadata = md_intra,
                                         variables = vars)
res_intra$qc

# Example 3: Inter-only, single replicate; estimates inter-observer
md_inter <- md
md_inter$replica <- 1L
res_inter <- observer_error_partitioning(data = trks,
                                         metadata = md_inter,
                                         variables = vars)
res_inter$qc

# Example 4: Circular metrics only (angles via sine–cosine embedding)
res_ang <- observer_error_partitioning(data = trks,
                                       metadata = md,
                                       variables = c("TurnAng","PaceAng"))
res_ang$summary

}
\references{
Fisher, N. I. (1995). Statistical Analysis of Circular Data. Cambridge University Press
}
\seealso{
\code{\link{tps_to_track}}, \code{\link{track_param}}
}
\author{
Humberto G. Ferrón

humberto.ferron@uv.es

Macroevolution and Functional Morphology Research Group (www.macrofun.es)

Cavanilles Institute of Biodiversity and Evolutionary Biology

Calle Catedrático José Beltrán Martínez, nº 2

46980 Paterna - Valencia - Spain

Phone: +34 (9635) 44477
}
